@page "/"
@using SudokuClassLibrary
@inject GameState GameState

<PageTitle>Sudoku Game</PageTitle>

<div class="main">
   
    @if (GameState == null)
    {
        <p>Loading game board ...</p>
    }
    else
    {   
        <div class="game-container">
            <div class="game-column">
                <h1>@GameTitle</h1>

                <table>
                    @for (int row = 0; row <= 8; row++)
                    {
                        <tr>
                            @for (int column = 0; column <= 8; column++)
                            {
                                <td class="grid">
                                    <Cell
                                        GameState="GameState"
                                        CellRow="@row"
                                        CellColumn="@column"
                                        OnValueError=@ShowError />
                                </td>
                            }
                        </tr>
                    }
                </table>

                @if (TwoButtonDialogIsVisible)
                {
                    <TwoButtonDialog
                    Type="DialogType.AreYouSure"
                    Message=@DialogMessage
                    OnResult="HandleDialogResult" />
                }

                @if (ErrorDialogIsVisible)
                {
                    <SingleButtonDialog
                        Type="DialogType.Error"
                        Message=@ErrorMessage
                        OnClose="CloseError" />
                }

                @if (CongratulationsDialogIsVisible)
                {
                    <SingleButtonDialog
                        Type="DialogType.Congratulations"
                        Message="You've completed the game!"
                        OnClose="CloseCongratulations" />
                }

                @if (IsButtonGroupVisible(ButtonGroup.Setup))
                {
                    <div class="page-buttons-multiple">
                        <button class="btn btn-danger" 
                            disabled=@IsButtonDisabled(Button.ClearGrid)
                            @onclick="@ClearGridAsync">Clear game grid</button>
                        <button class="btn btn-success" 
                            disabled=@IsButtonDisabled(Button.StartGame)
                            @onclick="StartGame">Start game</button>
                    </div>
                }
                @if (IsButtonGroupVisible(ButtonGroup.Game))
                {
                    <div class="page-buttons-multiple">
                        <button class="@PauseContinueButtonClass pause-continue-button" 
                                disabled=@IsButtonDisabled(Button.PauseContinue)
                                @onclick="TogglePauseGame">@PauseContinueButtonText</button>
                        <button class="btn btn-warning"  
                                disabled=@IsButtonDisabled(Button.RestartGame)
                                @onclick="@RestartGameAsync">Restart game</button>
                        <button class="btn btn-danger" @onclick="@NewGameAsync">New game</button>
                    </div>
                }
                <div class="page-buttons-multiple">
                    <button class="btn btn-secondary" @onclick="@ClearGame">&lt; Undo</button>
                    <button class="btn btn-secondary" @onclick="StartGame">Redo &gt;</button>
                </div>
            </div>

                <div class="game-column">
                    <h2>Instructions</h2>

                    <p>Tick the checkbox to make this a <strong>Killer Sudoku</strong> game.</p>
                    
                    <div>
                        <span class="killer-container">
                            <label>Is Killer Sudoku:</label>
                            <input type="checkbox" class="checkbox-large" disabled=@IsKillerSudokuDisabled @bind="GameState.IsKillerSudoku" />
                        </span>
                    </div>
                    <p>&nbsp;</p>

                    <p>Click on squares to enter the initial values.</p>

                    <p>When you finish entering the initial values, click the 
                        <strong>Start Game</strong> button to start the game and timer.</p>

                    <p>The small numbers in each square indicate the possible                         
                            valid values for that square.</p>

                    <p>If a square has only one possible valid value it will be highlighted in pale yellow.</p>

                    <p>During the game click on a square to enter or remove a value.</p>

                    <p>The game will finish and the timer will stop when you set the value of the 
                        last square in the game grid.</p>

                    <p>At any time during the game you can use the following buttons:</p>
                    <ul>
                        <li><strong>Pause</strong> button:  Pauses the timer.  Continue the game again 
                            via the <strong>Continue</strong> button;</li>
                        <li><strong>Cancel</strong> button:  Cancels the game but leaves any set 
                            values in place (so you can see where you went wrong);</li>
                        <li><strong>New game</strong> button: Cancels the game and clears the game  
                            grid so you can start again.</li>
                        </ul>

                    <p>&nbsp;</p>
                        <p>Current game state: @GameState.Status</p>

                    <p>&nbsp;</p>
                    <p>Dialog button pressed: @DialogResult</p>
                </div>
        </div>
    }

</div>

@code
{
    #region Lifecycle Events **********************************************************************

    protected override void OnInitialized()
    {
        GameState.RefreshRequested += RefreshMe;
    }

    protected override async Task OnAfterRenderAsync (bool firstRender)
    {
        if (firstRender)
        {
            GameState.Status = GameStatus.Initial;
        }

        await base.OnAfterRenderAsync(firstRender);
    }

    public void Dispose()
    {
        GameState.RefreshRequested -= RefreshMe;
    }

    private async void RefreshMe()
    {
        await InvokeAsync(() => StateHasChanged());

        if (GameState.GameIsComplete)
        {
            ShowCongratulations();
        }
    }

    #endregion

    #region Miscellaneous setup *******************************************************************

    private string GameTitle => GameState.IsKillerSudoku ? "Killer Sudoku!" : "Sudoku!";
    private bool IsKillerSudokuDisabled => (GameState.Status != GameStatus.Initial 
                                        && GameState.Status != GameStatus.Setup);

    #endregion

    #region Button setup **************************************************************************

    private string PauseContinueButtonText => GameState.Status == GameStatus.Paused ? "Continue" : "Pause";
    private string PauseContinueButtonClass => GameState.Status == GameStatus.Paused ? "btn btn-primary" : "btn btn-info";

    private bool IsButtonDisabled(Button button)
    {
        switch (GameState.Status)
        {
            case GameStatus.Initial:
                return (button != Button.ClearGrid);
            case GameStatus.Setup:
                return (button != Button.ClearGrid && button != Button.StartGame);
            case GameStatus.GameStart:
                return (button != Button.PauseContinue && button != Button.NewGame);
            case GameStatus.Running:
            case GameStatus.Paused:
                return (button != Button.PauseContinue && button != Button.RestartGame 
                    && button != Button.NewGame);
            case GameStatus.Completed:
                return (button != Button.RestartGame && button != Button.NewGame);
            default:
                return true;
        }
    }

    private bool IsButtonGroupVisible(ButtonGroup buttonGroup)
    {
        switch (GameState.Status)
        {
            case GameStatus.Initial:
            case GameStatus.Setup:
                return (buttonGroup != ButtonGroup.Game);
            case GameStatus.GameStart:
            case GameStatus.Running:
            case GameStatus.Paused:
            case GameStatus.Completed:
                return (buttonGroup != ButtonGroup.Setup);
            default:
                return true;
        }
    }

    #endregion

    #region Button events *************************************************************************

    private void ClearGame()
    {
        GameState.Status = GameStatus.Initial;
    }

    private void StartGame()
    {
        GameState.Status = GameStatus.GameStart;
    }

    private void TogglePauseGame()
    {
        if (GameState.Status == GameStatus.GameStart || GameState.Status == GameStatus.Running)
        {
            PauseGame();
        }
        else if (GameState.Status == GameStatus.Paused)
        {
            ContinueGame();
        }
    }

    private void PauseGame()
    {
        GameState.Status = GameStatus.Paused;
    }

    private void ContinueGame()
    {
        // Will automatically be updated to GameStatus.Running if the grid has any game values set.
        GameState.Status = GameStatus.GameStart;
    }

    private async Task ClearGridAsync()
    {
        string dialogMessage = "Are you sure you want to clear all initial values?";
        Action actionOnConfirmation = () =>
        {
            GameState.Status = GameStatus.Initial;
        };

        await ActWithConfirmationAsync(dialogMessage, actionOnConfirmation);
    }

    private async Task RestartGameAsync()
    {
        string dialogMessage = "Are you sure you want to restart the game?";
        Action actionOnConfirmation = () =>
        {
            GameState.Status = GameStatus.GameStart;
        };

        await ActWithConfirmationAsync(dialogMessage, actionOnConfirmation);
    }

    private async Task NewGameAsync()
    {
        string dialogMessage = "Are you sure you want to cancel this game and start a new one?";
        Action actionOnConfirmation = () => ClearGame();

        await ActWithConfirmationAsync(dialogMessage, actionOnConfirmation);
    }

    private async Task ActWithConfirmationAsync(string dialogMessage, Action actionOnConfirmation)
    {
        // Want to pause the game while the dialog is open.  If the user chooses to cancel the 
        // action then want to resume the previous status.
        var previousStatus = GameState.Status;
        GameState.Status = GameStatus.Paused;

        DialogMessage = dialogMessage;
        DialogResult result = DialogResult.Unknown;

        ShowDialog();
        await Utilities.WaitUntil(() => DialogResult != DialogResult.Unknown);
        result = DialogResult;

        if (result == DialogResult.Ok)
        {
            actionOnConfirmation();
        }
        else
        {
            // If dialog cancelled return to the previous game state.
            GameState.Status = previousStatus;
        }
    }

    #endregion

    #region Dialog display ************************************************************************

    private bool TwoButtonDialogIsVisible { get; set; } = false;
    private string DialogMessage { get; set; } = "Are you sure?";
    private DialogResult DialogResult { get; set; } = DialogResult.Unknown;

    private bool ErrorDialogIsVisible { get; set; } = false;
    private string ErrorMessage { get; set; } = "An error occurred.";

    private bool CongratulationsDialogIsVisible { get; set; } = false;

    private void ShowDialog()
    {
        TwoButtonDialogIsVisible = true;
        DialogResult = DialogResult.Unknown;
    }

    private void HandleDialogResult(DialogResult result)
    {
        TwoButtonDialogIsVisible = false;

        DialogResult = result;
    }

    private void ShowError(string errorMessage)
    {
        ErrorMessage = errorMessage;
        ErrorDialogIsVisible = true;
    }

    private void CloseError()
    {
        ErrorDialogIsVisible = false;
        ErrorMessage = "An error occurred.";
    }

    private void ShowCongratulations()
    {
        CongratulationsDialogIsVisible = true;
    }

    private void CloseCongratulations()
    {
        CongratulationsDialogIsVisible = false;
    }

    #endregion
}
